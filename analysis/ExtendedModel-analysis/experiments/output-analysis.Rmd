---
title: "Output Analysis"
author: "Emily Coco"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggpubr)
library(betareg)
library(lmtest)
library(MASS)
library(bbmle)
library(pscl)
library(corrplot)
library(reshape2)
library(ggthemes)
library(naniar)
library(rcompanion)
library(fitdistrplus)


theme_set(theme_minimal())

parameters = c("max_use_intensity", "max_artifact_carry", "max_flake_size","max_nodules_size", "blank_prob", "scavenge_prob", "overlap","mu", "size_preference", "flake_preference","min_suitable_flake_size", "min_suitable_nodule_size", "strict_selection")

outputs = c("num.scav.events","total.recycled", "num.deposits",	"total.encounters",	"total.discards",	"total.manu.events", "total.retouches", "total.CR",	"total.RI")

move_outputs = c("num.deposits", "total.encounters")
scavenge_outputs = c("num.scav.events", "total.recycled", "total.discards", "total.manu.events", "total.retouches")


#alldata = read_csv("~/eclipse-workspace/recycling-Java/output/subset_model_data.csv")

alldata = alldata[alldata$size != "size",]

alldata = alldata[!is.na(alldata$max_artifact_carry),]

two.tech = alldata[which(alldata$overlap == 1),]
multi.tech = alldata[which(alldata$overlap == 2),]

```

```{r plot-functions, include=F}


```

```{r missing-values-analysis, eval=F}
facet_data = alldata[,c(parameters, outputs)]

missing_exp = facet_data %>% group_by_at(parameters) %>% miss_var_summary %>%
  filter(n_miss != 0)
rm(missing_exp)
miss.RI.val = missing_exp[which(missing_exp$variable == "total.RI"),-14]
write_csv(miss.RI.val, file = "missing-RI-values-by-experiment.csv")

descdist(miss.RI.val$pct_miss, discrete=F)

brall = betareg::betareg(pct_miss ~ ., data = miss.RI.val[,-14])
qqnorm(residuals(brall, type = "sweighted2"))
qqline(residuals(brall, type = "sweighted2"))
summary(brall)

# missing_time = alldata %>% 
#   group_by_at(c(parameters, "model_year")) %>% 
#   miss_var_summary %>% 
#   filter(n_miss != 0)

```



## End of model run analysis
What is the resulting archaeological record look like at the last point in model run?

#### Two technology types
How is recycling intensity correlated with the other output variables?
```{r end-result-two, eval=T}

endyear = two.tech$start_year[1] + (two.tech$timestep[1] * two.tech$total_steps[1])

enddata = two.tech[which(two.tech$model_year == endyear),]
endoutputs = enddata[,outputs]
rm(enddata)
M = cor(endoutputs)
p.mat = cor.mtest(endoutputs)
corrplot(M, type = "upper", method="color", addCoef.col = "black", p.mat = p.mat$p, sig.level = 0.01, tl.col="black", tl.srt=45, number.cex=0.75)


rm(endoutputs)
```

#### Many technology types
How is recycling intensity correlated with the other output variables?
```{r end-result-many, eval=T}

endyear = multi.tech$start_year[1] + (multi.tech$timestep[1] * multi.tech$total_steps[1])

enddata = multi.tech[which(multi.tech$model_year == endyear),]
endoutputs = enddata[,outputs]
rm(enddata)
M = cor(endoutputs)
p.mat = cor.mtest(endoutputs)
corrplot(M, type = "upper", method="color", addCoef.col = "black", p.mat = p.mat$p, sig.level = 0.01, tl.col="black", tl.srt=45, number.cex=0.75)


rm(endoutputs)
```

## Middle of model run analysis
What is the resulting archaeological record look like in the middle of model run?

#### Two technology types
How is recycling intensity correlated with the other output variables?
```{r mid-result-two, eval=T, warning=F}

midyear = two.tech$start_year[1] + (two.tech$timestep[1] * (two.tech$total_steps[1]/2))

middata = two.tech[which(two.tech$model_year == midyear),]
midoutputs = middata[,outputs]
rm(middata)

M = cor(midoutputs)
p.mat = cor.mtest(midoutputs)
corrplot(M, type = "upper", method="color", addCoef.col = "black", p.mat = p.mat$p, sig.level = 0.01, tl.col="black", tl.srt=45, number.cex=0.75)


rm(midoutputs)
```

#### Many technology types
How is recycling intensity correlated with the other output variables?
```{r mid-result-many, eval=T, warning=F}

midyear = multi.tech$start_year[1] + (multi.tech$timestep[1] * (multi.tech$total_steps[1]/2))

middata = multi.tech[which(multi.tech$model_year == midyear),]
midoutputs = middata[,outputs]
rm(middata)

M = cor(midoutputs)
p.mat = cor.mtest(midoutputs)
corrplot(M, type = "upper", method="color", addCoef.col = "black", p.mat = p.mat$p, sig.level = 0.01, tl.col="black", tl.srt=45, number.cex=0.75)


rm(midoutputs)
```

## Change in correlations between outputs over time

#### Two technology types
```{r cor-change-two, warning=F}
cor.list = list()
l = 1
for(i in unique(two.tech$model_year)){
  yeardata = two.tech[which(two.tech$model_year == i),]
  yearoutputs = yeardata[,outputs]
  
  M = cor(yearoutputs)
  M.df = as.data.frame(melt(M))
  if(sum(is.na(M.df$value)) != 72) {
    p.mat = cor.mtest(yearoutputs)
    p.mat.df = as.data.frame(melt(p.mat$p))
  } else {
    p.mat = cor(yearoutputs)
    p.mat.df = as.data.frame(melt(p.mat))
    p.mat.df$value = NA
  }
  
  ##combine M and p.mat
  comb = cbind(M.df, p.mat.df)[,c(1:3, 6)]
  colnames(comb) = c("output1", "output2", "correlation", "signf")
  final = comb %>% distinct(output1, output2, .keep_all = T)
  final$model_year = i
  
  cor.list[[l]] = final
  l = l+1
}

cor.time = do.call('rbind', cor.list)
rm(cor.list)
cor.time$signf.val = ifelse(cor.time$signf < 0.05, "signf.", "not signf.")
plot.cor.time = cor.time[which(!is.na(cor.time$signf.val)),]
plot.cor.time = plot.cor.time[which(plot.cor.time$output1 != plot.cor.time$output2),]
rm(cor.time)

ggplot(plot.cor.time, aes(x = model_year, y = correlation, color = signf.val)) +
  geom_point(size = 0.1) +
  #geom_smooth(se = F) +
  facet_grid(output1 ~ output2) +
  scale_x_reverse(breaks = c(500000, midyear, endyear)) +
  theme(axis.text.x = element_text(angle = 90, size = 3),
        strip.text = element_text(size = 5),
        strip.text.y = element_text(angle = 360), 
        strip.text.x = element_text(angle = 45), 
        legend.title = element_blank()) +
  labs(x = "model year") +
  scale_color_colorblind()

```

#### Many technology types
```{r cor-change-many, warning=F}
cor.list = list()
l = 1
for(i in unique(multi.tech$model_year)){
  yeardata = multi.tech[which(multi.tech$model_year == i),]
  yearoutputs = yeardata[,outputs]
  
  M = cor(yearoutputs)
  M.df = as.data.frame(melt(M))
  if(sum(is.na(M.df$value)) != 72) {
    p.mat = cor.mtest(yearoutputs)
    p.mat.df = as.data.frame(melt(p.mat$p))
  } else {
    p.mat = cor(yearoutputs)
    p.mat.df = as.data.frame(melt(p.mat))
    p.mat.df$value = NA
  }
  
  ##combine M and p.mat
  comb = cbind(M.df, p.mat.df)[,c(1:3, 6)]
  colnames(comb) = c("output1", "output2", "correlation", "signf")
  final = comb %>% distinct(output1, output2, .keep_all = T)
  final$model_year = i
  
  cor.list[[l]] = final
  l = l+1
}

cor.time = do.call('rbind', cor.list)
rm(cor.list)
cor.time$signf.val = ifelse(cor.time$signf < 0.05, "signf.", "not signf.")
plot.cor.time = cor.time[which(!is.na(cor.time$signf.val)),]
plot.cor.time = plot.cor.time[which(plot.cor.time$output1 != plot.cor.time$output2),]
rm(cor.time)

ggplot(plot.cor.time, aes(x = model_year, y = correlation, color = signf.val)) +
  geom_point(size = 0.1) +
  #geom_smooth(se = F) +
  facet_grid(output1 ~ output2) +
  scale_x_reverse(breaks = c(500000, midyear, endyear)) +
  theme(axis.text.x = element_text(angle = 90, size = 3),
        strip.text = element_text(size = 5),
        strip.text.y = element_text(angle = 360), 
        strip.text.x = element_text(angle = 45), 
        legend.title = element_blank()) +
  labs(x = "model year") +
  scale_color_colorblind()

```