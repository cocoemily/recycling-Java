---
title: "Output Analysis"
author: "Emily Coco"
date: "2/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggpubr)
library(betareg)
library(lmtest)
library(MASS)
library(bbmle)
library(pscl)
library(corrplot)
library(reshape2)
library(ggthemes)


theme_set(theme_minimal())

parameters = c("max_use_intensity", "max_artifact_carry", "max_flake_size","max_nodules_size", "blank_prob", "scavenge_prob", "overlap","mu", "size_preference", "flake_preference","min_suitable_flake_size", "min_suitable_nodule_size", "strict_selection")

outputs = c("num.scav.events","total.recycled", "num.deposits",	"total.encounters",	"total.discards",	"total.manu.events", "total.retouches", "total.CR",	"total.RI")

move_outputs = c("num.deposits", "total.encounters")
scavenge_outputs = c("num.scav.events", "total.recycled", "total.discards", "total.manu.events", "total.retouches")


#alldata = read_csv("~/eclipse-workspace/recycling-Java/output/subset_model_data.csv")

alldata = alldata[alldata$size != "size",]

alldata = alldata[!is.na(alldata$max_artifact_carry),]


```

```{r plot-functions, include=F}


```



## End of model run analysis
What is the resulting archaeological record look like at the last point in model run?

How is recycling intensity correlated with the other output variables?
```{r end-result, eval=T}

endyear = alldata$start_year[1] + (alldata$timestep[1] * alldata$total_steps[1])

enddata = alldata[which(alldata$model_year == endyear),]
endoutputs = enddata[,outputs]
rm(enddata)
M = cor(endoutputs)
p.mat = cor.mtest(endoutputs)
corrplot(M, type = "upper", method="color", addCoef.col = "black", p.mat = p.mat$p, sig.level = 0.01, tl.col="black", tl.srt=45, number.cex=0.75)


rm(endoutputs)
```


## Middle of model run analysis
What is the resulting archaeological record look like in the middle of model run?

How is recycling intensity correlated with the other output variables?
```{r mid-result, eval=T, warning=F}

midyear = alldata$start_year[1] + (alldata$timestep[1] * (alldata$total_steps[1]/2))

middata = alldata[which(alldata$model_year == midyear),]
midoutputs = middata[,outputs]
rm(middata)

M = cor(midoutputs)
p.mat = cor.mtest(midoutputs)
corrplot(M, type = "upper", method="color", addCoef.col = "black", p.mat = p.mat$p, sig.level = 0.01, tl.col="black", tl.srt=45, number.cex=0.75)


rm(midoutputs)
```

## Change in correlations between outputs over time
```{r cor-change, warning=F}
cor.list = list()
l = 1
for(i in unique(alldata$model_year)){
  yeardata = alldata[which(alldata$model_year == i),]
  yearoutputs = yeardata[,outputs]
  
  M = cor(yearoutputs)
  M.df = as.data.frame(melt(M))
  if(sum(is.na(M.df$value)) != 72) {
    p.mat = cor.mtest(yearoutputs)
    p.mat.df = as.data.frame(melt(p.mat$p))
  } else {
    p.mat = cor(yearoutputs)
    p.mat.df = as.data.frame(melt(p.mat))
    p.mat.df$value = NA
  }
  
  ##combine M and p.mat
  comb = cbind(M.df, p.mat.df)[,c(1:3, 6)]
  colnames(comb) = c("output1", "output2", "correlation", "signf")
  final = comb %>% distinct(output1, output2, .keep_all = T)
  final$model_year = i
  
  cor.list[[l]] = final
  l = l+1
}

cor.time = do.call('rbind', cor.list)
rm(cor.list)
cor.time$signf.val = ifelse(cor.time$signf < 0.05, "signf.", "not signf.")
rm(cor.time)
plot.cor.time = cor.time[which(!is.na(cor.time$signf.val)),]

ggplot(plot.cor.time, aes(x = model_year, y = correlation, color = signf.val)) +
  geom_point(size = 0.1) +
  #geom_smooth(se = F) +
  facet_grid(output1 ~ output2) +
  scale_x_reverse(breaks = c(500000, midyear, endyear)) +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text = element_text(size = 5),
        strip.text.y = element_text(angle = 360)) +
  scale_color_colorblind()

```

